name: CI

on:
  workflow_dispatch:

jobs:
  dfu-util:
    runs-on: ubuntu-latest

    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Get yesterdays date
        id: yesterday
        run: echo "::set-output name=date::$(date --date="yesterday" +'%Y-%m-%d')"
      - uses: actions/checkout@v2
        with:
          repository: 'yosyshq/fpga-nightly'
          ref: 'packages'
      - name: Cache sources
        id: cache-sources
        uses: actions/cache@v2
        with:
          path: _sources
          key: cache-sources-${{ steps.date.outputs.date }}
          restore-keys: |
            cache-sources-
      - name: Cache hashes
        id: cache-hashes
        uses: actions/cache@v2
        with:
          path: _hashes
          key: cache-hashes-linux-x64-dfu-util-${{ steps.date.outputs.date }}
          restore-keys: |
            cache-hashes-linux-x64-dfu-util-${{ steps.yesterday.outputs.date }}
            cache-hashes-linux-x64-dfu-util-
      - name: Build
        run: ./nightly.py build --arch=linux-x64 --target=dfu-util
      - uses: actions/upload-artifact@v2
        if: hashFiles('_outputs/linux-x64/dfu-util/*') != ''
        with:
          name: dfu-util
          path: _outputs/linux-x64/dfu-util/*.tgz 
      - uses: ncipollo/release-action@v1
        if: hashFiles('_outputs/linux-x64/dfu-util/*') != ''
        with:
          allowUpdates: True
          body: ""
          tag: fpga-nightly-${{ steps.date.outputs.date }}
          artifacts: "_outputs/linux-x64/dfu-util/*.tgz"
          token: ${{ secrets.GITHUB_TOKEN }}

  ecpprog:
    runs-on: ubuntu-latest

    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Get yesterdays date
        id: yesterday
        run: echo "::set-output name=date::$(date --date="yesterday" +'%Y-%m-%d')"
      - uses: actions/checkout@v2
        with:
          repository: 'yosyshq/fpga-nightly'
          ref: 'packages'
      - name: Cache sources
        id: cache-sources
        uses: actions/cache@v2
        with:
          path: _sources
          key: cache-sources-${{ steps.date.outputs.date }}
          restore-keys: |
            cache-sources-
      - name: Cache hashes
        id: cache-hashes
        uses: actions/cache@v2
        with:
          path: _hashes
          key: cache-hashes-linux-x64-ecpprog-${{ steps.date.outputs.date }}
          restore-keys: |
            cache-hashes-linux-x64-ecpprog-${{ steps.yesterday.outputs.date }}
            cache-hashes-linux-x64-ecpprogl-
      - name: Build
        run: ./nightly.py build --arch=linux-x64 --target=ecpprog
      - uses: actions/upload-artifact@v2
        if: hashFiles('_outputs/linux-x64/ecpprog/*') != ''
        with:
          name: ecpprog
          path: _outputs/linux-x64/ecpprog/*.tgz 
      - uses: ncipollo/release-action@v1
        if: hashFiles('_outputs/linux-x64/ecpprog/*') != ''
        with:
          allowUpdates: True
          body: ""
          tag: fpga-nightly-${{ steps.date.outputs.date }}
          artifacts: "_outputs/linux-x64/ecpprog/*.tgz"
          token: ${{ secrets.GITHUB_TOKEN }}
